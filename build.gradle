/*
 * This file was generated by the Gradle 'init' task.
 */



//See: https://docs.gradle.org/current/userguide/organizing_gradle_projects.html#sec:build_sources
plugins {
    id 'java'

    id 'application'

    id 'org.graalvm.buildtools.native' version '0.9.28'

    id 'com.github.johnrengelman.shadow' version '8.1.1'
}


jar {
    manifest {
        attributes 'Main-Class': application.mainClass
    }
}


application {
    mainClass = 'sample.hibernate.DbMain'
}

version = "0.0.1"

// REPOSITORIES
logger.lifecycle("Adding repositories for project: ${project.name}")

//ext.artifactoryMaven("maven2-remote")
//ext.artifactoryMaven("jcenter")
//ext.artifactoryMaven("maven-central-remote")

repositories{
    mavenCentral()
    jcenter()
}


configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}


tasks.withType(JavaCompile) {
    options.encoding = "UTF-8"
}



dependencies {

    // Lombok
    // https://mvnrepository.com/artifact/org.projectlombok/lombok
    compileOnly("org.projectlombok:lombok:1.18.30")
    annotationProcessor("org.projectlombok:lombok:1.18.30")

    testCompileOnly("org.projectlombok:lombok:1.18.30")
    testAnnotationProcessor("org.projectlombok:lombok:1.18.30")

    // https://mvnrepository.com/artifact/ch.qos.logback/logback-core
    implementation 'ch.qos.logback:logback-core:1.3.11'

    // https://mvnrepository.com/artifact/ch.qos.logback/logback-classic
    implementation ("ch.qos.logback:logback-classic:1.3.11")

    // https://mvnrepository.com/artifact/org.slf4j/slf4j-api
    implementation("org.slf4j:slf4j-api:2.0.7")

    // https://mvnrepository.com/artifact/com.h2database/h2
    implementation 'com.h2database:h2:2.2.224' //1.2.147' //2.1.214'

    // https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils
    implementation 'commons-beanutils:commons-beanutils:1.8.2'

    // https://mvnrepository.com/artifact/antlr/antlr
    implementation group: 'antlr', name: 'antlr', version: '2.7.5'

    // https://mvnrepository.com/artifact/asm/asm
    implementation group: 'asm', name: 'asm', version: '1.5.3'

    // https://mvnrepository.com/artifact/asm/asm-attrs
    implementation group: 'asm', name: 'asm-attrs', version: '1.5.3'

    // https://mvnrepository.com/artifact/dom4j/dom4j
    implementation group: 'dom4j', name: 'dom4j', version: '1.6.1'

    // Hibernate ------------------------------------------------------------

    // TODO Dejan check: https://github.com/oracle/graal/issues/4484

	// https://mvnrepository.com/artifact/org.hibernate.orm/hibernate-core
    implementation ('org.hibernate.orm:hibernate-core:6.1.1.Final') //6.3.1.Final
            //{ exclude group: 'net.bytebuddy', module: 'byte-buddy' }

    // https://mvnrepository.com/artifact/net.bytebuddy/byte-buddy
    //implementation 'net.bytebuddy:byte-buddy:1.14.9'

}



// NOTE: Parameter info: https://www.graalvm.org/22.0/reference-manual/native-image/Options/
// More information: https://www.graalvm.org/latest/reference-manual/java/options/
graalvmNative {

//    agent {
//        defaultMode = "standard"
//    }

    //https://docs.oracle.com/en/graalvm/enterprise/22/docs/reference-manual/native-image/guides/use-reachability-metadata-repository-gradle/#summary
    metadataRepository {
        enabled = true
    }

    toolchainDetection = false

    binaries {
        main {
            imageName = 'DB' // The name of the native image, defaults to the project name

            mainClass = application.mainClass

            sharedLibrary = false // dont create a dll

            // agent {
            //     enabled = true // Enables the reflection agent. Can be also set on command line using '-Pagent'
            // }

            buildArgs.add('--verbose')

            //buildArgs.add('--initialize-at-build-time=org.hibernate.persister.entity.SingleTableEntityPersister')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.LoggerProviders')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.core.util.StatusPrinter')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.core.util.Loader')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.Logger')
            //buildArgs.add('--initialize-at-build-time=org.slf4j.LoggerFactory')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.core.status.StatusBase')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.DelegatingBasicLogger')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.classic.Level')
            //buildArgs.add('--initialize-at-build-time=org.hibernate.internal.CoreMessageLogger_$logger')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.core.CoreConstants')
            //buildArgs.add('--initialize-at-build-time=ch.qos.logback.classic.Logger')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.LoggingLocale')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.Slf4jLocationAwareLogger$1')
            //buildArgs.add('--initialize-at-build-time=org.jboss.logging.Slf4jLocationAwareLogger')

            //buildArgs.add('--initialize-at-build-time=net.bytebuddy.utility.Invoker$Dispatcher')


            //buildArgs.add('-XX:+UnlockExperimentalVMOptions')
            //buildArgs.add('-H:+UnlockExperimentalVMOptions')
            //buildArgs.add('-H:-UnlockExperimentalVMOptions')

            buildArgs.add('--enable-http')
            buildArgs.add('--enable-https')
            buildArgs.add('--no-server')
            buildArgs.add('--no-fallback')

            buildArgs.add('-H:+JNI')
            buildArgs.add('-H:+AddAllCharsets')
            buildArgs.add('--initialize-at-run-time=com.sun.jna')
            buildArgs.add('--allow-incomplete-classpath')

        }
    }
}


//Collect metadata with AGENT
//java -agentlib:native-image-agent=config-output-dir=META-INF/native-image,experimental-class-define-support -cp "HibernateSampleGraalVM-0.0.1-all.jar;." sample.hibernate.DbMain

// Compile
//.\gradlew :HibernateSample:nativeCompile

//native-image --verbose -o "DB" -cp "HibernateSampleGraalVM-0.0.1-all.jar;." sample.hibernate.DbMain
